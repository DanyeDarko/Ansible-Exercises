---
-
    name: Automatisacion Droplets
    hosts: localhost
    vars:
      droplets:
        - name: centos-nyc-dockernode-01
          id: 1
          distro: &centos centos-8-x64
          region: nyc1
        - name: centos-nyc-dockernode-02
          id: 2
          distro: *centos
          region: nyc2
        - name: debian-nyc-dockernode-03
          id: 3
          distro: &debian debian-9-x64
          region: nyc2

        
          
    connection: local
    gather_facts: False 
    tasks:

      - name: Verificar SSH-KEY y CREAR si no existe en Digital Ocean
        digital_ocean:
          state: present
          command : ssh
          name: "ansible-agent"
          ssh_pub_key: "{{ lookup('file','~/.ssh/id_rsa.pub') }}"
        register: ssh_result
      - debug:
          msg: "Llave Creada con exito {{ ssh_result.ssh_key.id}}"

      - name: 'create {{ item.name }} Droplet'
        digital_ocean_droplet:
          id: '{{item.id}}'
          image: '{{item.distro}}'
          name: '{{ item.name }}'
          size: 4gb
          monitoring: yes
          state: present
          region: nyc1
          wait_timeout: 500
          ssh_keys: 
            - '{{ ssh_result.ssh_key.id }}'
        register: do_droplet
        loop: '{{ droplets }}'

      - debug:
           var: do_droplet.results[0].data.droplet.name 

      - name: Crear hosts file
        copy:
          dest: ~/Documents/EJERCICIOS CURSOS/ansible/ejercicio3/hosts
          content: |
              [digital_ocean_cluster]
              {{do_droplet.results[0].data.droplet.name}} ansible_host={{do_droplet.results[0].data.ip_address}} 
              {{do_droplet.results[1].data.droplet.name}} ansible_host={{do_droplet.results[1].data.ip_address}} 