---
-
    name: Automatisacion Droplets
    hosts: localhost
    connection: local
    gather_facts: False 
    tasks:

      - name: Leer variables para la creacion  de nodos
        include_vars: 
          file: ~/Documents/EJERCICIOS CURSOS/ansible/ejercicio3/nodes_digital_ocean.yml 

      - name: Verificar SSH-KEY y CREAR si no existe en Digital Ocean
        digital_ocean:
          state: present
          command : ssh
          name: "ansible-agent"
          ssh_pub_key: "{{ lookup('file','~/.ssh/id_rsa.pub') }}"
        register: ssh_result
      - debug:
          msg: "Llave Creada con exito {{ ssh_result.ssh_key.id}}"

      - name: 'create {{ item.name }} Droplet'
        digital_ocean_droplet:
          id: '{{item.id}}'
          image: '{{item.distro}}'
          name: '{{ item.name }}'
          size: 4gb
          monitoring: yes
          state: present
          region: nyc1
          wait_timeout: 500
          ssh_keys: 
            - '{{ ssh_result.ssh_key.id }}'
        register: do_droplet
        loop: '{{ droplets }}'

      - name: Crear hosts file
        copy:
          dest: ~/Documents/EJERCICIOS CURSOS/ansible/ejercicio3/hosts
          content: |
              [digital_ocean_cluster]
              {{do_droplet.results[0].data.droplet.name}} ansible_host={{do_droplet.results[0].data.ip_address}} 
              {{do_droplet.results[1].data.droplet.name}} ansible_host={{do_droplet.results[1].data.ip_address}} 
              {{do_droplet.results[2].data.droplet.name}} ansible_host={{do_droplet.results[2].data.ip_address}} 